<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Reviews - Performance Management System</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <%
    function getPerformanceLevel(score) {
        if (score >= 6) return 'Outstanding Performance';
        if (score >= 5) return 'Superior Performance';
        if (score >= 4) return 'Effective Performance';
        if (score >= 3) return 'Standard Performance';
        if (score >= 2) return 'Developing Performance';
        return 'Ineffective Performance';
    }
    %>

    <% if (user) { %>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <h2>PMS - <%= user.role.toUpperCase() %></h2>
            </div>
            <div class="nav-menu">
                <span class="nav-user">
                    <i class="fas fa-user"></i>
                    <%= user.name %> (<%= user.employeeId %>)
                </span>
                <a href="/hod/dashboard" class="btn btn-outline">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
                <form action="/auth/logout" method="POST" style="display: inline;" onsubmit="return handleLogout(this)">
                    <button type="submit" class="btn btn-outline">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </form>
            </div>
        </div>
    </nav>
    <% } %>

    <main class="main-content">
        <div class="reviews-page">
            <div class="page-header">
                <h1>Review Management - <%= department.name %></h1>
                <div class="header-info">
                    <!-- Month selector -->
                    <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.75rem;">
                        <label for="monthSelector" style="margin: 0; font-weight: 600;">Select Month:</label>
                        <select id="monthSelector" onchange="handleMonthChange()" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <% availableMonths.forEach(month => { %>
                                <option value="<%= month %>" <%= month === selectedMonth ? 'selected' : '' %>>
                                    <%= month %>
                                </option>
                            <% }) %>
                        </select>
                    </div>
                    <!-- Action buttons -->
                    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: nowrap; overflow-x: auto;">
                        <a href="/hod/analysis" class="btn btn-primary" style="font-size: 0.8rem; padding: 0.5rem 1rem; white-space: nowrap;">
                            <i class="fas fa-chart-bar"></i> View Detailed Analysis
                        </a>
                        <a href="/hod/export/reviews<% if (selectedMonth) { %>?month=<%= encodeURIComponent(selectedMonth) %><% } %>" class="btn btn-outline" style="font-size: 0.8rem; padding: 0.5rem 1rem; white-space: nowrap;">
                            <i class="fas fa-download"></i> Export Reviews
                        </a>
                        <a href="/hod/export/performance<% if (selectedMonth) { %>?month=<%= encodeURIComponent(selectedMonth) %><% } %>" class="btn btn-outline" style="font-size: 0.8rem; padding: 0.5rem 1rem; white-space: nowrap;">
                            <i class="fas fa-chart-bar"></i> Export Performance
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="reviews-tabs">
                <button class="tab-btn active" onclick="showTab('employees')">Department Employees</button>
                <button class="tab-btn" onclick="showTab('dept-hods')">Department HODs</button>
                <button class="tab-btn" onclick="showTab('other-hods')">Other HODs</button>
                <button class="tab-btn" onclick="showTab('history')">Review History</button>
            </div>
            
            <!-- Department Employees Tab -->
            <div id="employees-tab" class="tab-content active">
                <div class="reviews-card">
                    <h3 id="employeesHeader">Department Employees to Review (<%= selectedMonth %>)</h3>
                    <div class="employees-to-review">
                        <% employeesToReview.forEach(employee => { %>
                            <div class="employee-card">
                                <div class="employee-info">
                                    <h4><%= employee.name %></h4>
                                    <p>ID: <%= employee.employeeId %></p>
                                    <p>Email: <%= employee.email %></p>
                                    <p>Department: <%= employee.department ? employee.department.name : 'Not Assigned' %></p>
                                    <p>Joined: <%= new Date(employee.joiningDate).toLocaleDateString() %></p>
                                </div>
                                <button class="btn btn-primary" onclick="openReviewModal('<%= employee._id %>', '<%= employee.name %>', '<%= employee.employeeId %>', 'employee')">
                                    <i class="fas fa-edit"></i> Review
                                </button>
                            </div>
                        <% }) %>
                        <% if (employeesToReview.length === 0) { %>
                            <p class="no-employees">All department employees have been reviewed for this month!</p>
                        <% } %>
                    </div>
                </div>
            </div>
            
            <!-- Department HODs Tab -->
            <div id="dept-hods-tab" class="tab-content">
                <div class="reviews-card">
                    <h3 id="deptHodsHeader">Department HODs to Review (<%= selectedMonth %>)</h3>
                    <div class="employees-to-review">
                        <% departmentHODsToReview.forEach(hod => { %>
                            <div class="employee-card">
                                <div class="employee-info">
                                    <h4><%= hod.name %></h4>
                                    <p>ID: <%= hod.employeeId %></p>
                                    <p>Level: <%= hod.hodLevel ? hod.hodLevel.toUpperCase() : 'N/A' %></p>
                                    <p>Email: <%= hod.email %></p>
                                    <p>Department: <%= hod.department ? hod.department.name : 'Not Assigned' %></p>
                                </div>
                                <button class="btn btn-primary" onclick="openReviewModal('<%= hod._id %>', '<%= hod.name %>', '<%= hod.employeeId %>', 'hod')">
                                    <i class="fas fa-edit"></i> Review
                                </button>
                            </div>
                        <% }) %>
                        <% if (departmentHODsToReview.length === 0) { %>
                            <p class="no-employees">All department HODs have been reviewed for this month!</p>
                        <% } %>
                    </div>
                </div>
            </div>
            
            <!-- Other HODs Tab -->
            <div id="other-hods-tab" class="tab-content">
                <div class="reviews-card">
                    <h3 id="otherHodsHeader">HODs from Other Departments (<%= selectedMonth %>)</h3>
                    <div class="employees-to-review">
                        <% otherHODsToReview.forEach(hod => { %>
                            <div class="employee-card">
                                <div class="employee-info">
                                    <h4><%= hod.name %></h4>
                                    <p>ID: <%= hod.employeeId %></p>
                                    <p>Department: <%= hod.department.name %></p>
                                    <p>Level: <%= hod.hodLevel ? hod.hodLevel.toUpperCase() : 'N/A' %></p>
                                </div>
                                <button class="btn btn-primary" onclick="openReviewModal('<%= hod._id %>', '<%= hod.name %>', '<%= hod.employeeId %>', 'hod')">
                                    <i class="fas fa-edit"></i> Review
                                </button>
                            </div>
                        <% }) %>
                        <% if (otherHODsToReview.length === 0) { %>
                            <p class="no-employees">All HODs from other departments have been reviewed for this month!</p>
                        <% } %>
                    </div>
                </div>
            </div>
            
            <!-- Review History Tab -->
            <div id="history-tab" class="tab-content">
                <div class="reviews-card">
                    <h3>All Reviews History</h3>
                    <div class="reviews-history">
                        <% allReviews.forEach(review => { %>
                            <div class="review-history-item">
                                <div class="review-header">
                                    <strong><%= review.employee.name %> (<%= review.employee.role.toUpperCase() %>)</strong>
                                    <span class="review-quarter"><%= review.month %></span>
                                </div>
                                <div class="review-score">
                                    <span class="score"><%= review.overallScore || review.score || 'N/A' %>/6</span>
                                    <div class="stars">
                                        <% 
                                        const score = review.overallScore || review.score || 0;
                                        for (let i = 1; i <= 6; i++) {
                                            if (i <= Math.round(score)) { %>
                                                ★
                                            <% } else { %>
                                                ☆
                                            <% }
                                        } %>
                                    </div>
                                    <div class="performance-level">
                                        <% 
                                        const performanceLevel = getPerformanceLevel(score);
                                        %>
                                        <span class="level-badge level-<%= performanceLevel.toLowerCase().replace(' ', '-') %>">
                                            <%= performanceLevel %>
                                        </span>
                                    </div>
                                </div>
                                <% if (review.answers && review.answers.length > 0) { %>
                                    <div class="review-details">
                                        <h5>Question Ratings:</h5>
                                        <% review.answers.forEach(answer => { %>
                                            <div class="question-rating">
                                                <span class="question-text"><%= answer.question ? answer.question.text : 'Question not found' %></span>
                                                <span class="rating"><%= answer.rating %>/6</span>
                                                <span class="category-badge category-<%= answer.question ? answer.question.category : 'unknown' %>">
                                                    <%= answer.question ? answer.question.category.replace('_', ' ').toUpperCase() : 'UNKNOWN' %>
                                                </span>
                                            </div>
                                        <% }) %>
                                    </div>
                                <% } %>
                                <div class="review-comments">
                                    <h5>Comments:</h5>
                                    <p><%= review.comments %></p>
                                </div>
                                <div class="review-date">
                                    Reviewed on: <%= new Date(review.reviewDate).toLocaleDateString() %>
                                </div>
                            </div>
                        <% }) %>
                        <% if (allReviews.length === 0) { %>
                            <p>No reviews submitted yet</p>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        <!-- Review Modal -->
        <div id="reviewModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Submit Review</h3>
                    <span class="close" onclick="closeReviewModal()">&times;</span>
                </div>
                
                <div class="modal-body-wrapper">
                    <div class="review-left-panel">
                        <div class="employee-details">
                            <h4 id="employeeName"></h4>
                            <p id="employeeIdDisplay"></p>
                            
                            <div id="previousScoreSection" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
                                <p style="margin: 0.25rem 0; color: #666; font-size: 0.9rem;">
                                    <strong>Previous Month Score:</strong>
                                </p>
                                <p id="previousScore" style="margin: 0; font-size: 1.3rem; color: #2196F3; font-weight: bold;"></p>
                            </div>
                        </div>

                        <div id="previousReviewSection" class="previous-review-section" style="display: none;">
                            <h5 style="margin-top: 0; color: #2196F3;">Previous Review</h5>
                            <div id="previousReviewContent"></div>
                        </div>

                        <div id="selfAssessmentSection" class="self-assessment-section" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
                            <h5 style="margin-top: 0; color: #4CAF50;">Self-Assessment</h5>
                            <div id="selfAssessmentContent"></div>
                        </div>
                    </div>

                    <div class="review-right-panel">
                        <form id="reviewForm" class="review-form">
                            <input type="hidden" id="employeeId" name="employee">
                            <!-- Added hidden input to pass selected month to review form -->
                            <input type="hidden" id="selectedMonth" name="month">
                            
                            <% if (questions && questions.length > 0) { %>
                                <div id="questionsContainer" class="questions-container">
                                    <% questions.forEach((question, index) => { %>
                                        <div class="question-group" data-department="<%= question.department ? question.department._id : 'global' %>">
                                            <label class="question-label"><%= question.text %></label>
                                            <span class="question-category category-<%= question.category %>">
                                                <%= question.category.replace('_', ' ').toUpperCase() %>
                                            </span>
                                            <div class="rating-selector">
                                                <% for (let rating = 1; rating <= 6; rating++) { %>
                                                    <label class="rating-option">
                                                        <input type="radio" name="question_<%= question._id %>" value="<%= rating %>" required>
                                                        <span class="rating-text"><%= rating %> - 
                                                            <% if (rating === 1) { %>Ineffective Performance
                                                            <% } else if (rating === 2) { %>Developing Performance
                                                            <% } else if (rating === 3) { %>Standard Performance
                                                            <% } else if (rating === 4) { %>Effective Performance
                                                            <% } else if (rating === 5) { %>Superior Performance
                                                            <% } else { %>Outstanding Performance<% } %>
                                                        </span>
                                                    </label>
                                                <% } %>
                                            </div>
                                        </div>
                                    <% }) %>
                                </div>
                            <% } else { %>
                                <div class="no-questions">
                                    <p>No questions available. Please contact admin to add review questions.</p>
                                </div>
                            <% } %>
                            
                            <div class="form-group">
                                <label for="comments">Overall Comments</label>
                                <textarea id="comments" name="comments" rows="4" required 
                                    placeholder="Provide detailed feedback on the person's performance..."></textarea>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-outline" onclick="closeReviewModal()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Submit Review</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="/js/main.js"></script>
    <script>
    const previousReviewsMap = <%- JSON.stringify(previousReviewsMap) %>;
    const selfAssessmentsMap = <%- selfAssessmentsMap %>;

    function handleMonthChange() {
        const selectedMonth = document.getElementById('monthSelector').value;
        window.location.href = `/hod/reviews?month=${encodeURIComponent(selectedMonth)}`;
    }

    function handleLogout(form) {
        const button = form.querySelector('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging out...';
        button.disabled = true;
        
        return true;
    }

    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        document.getElementById(tabName + '-tab').classList.add('active');
        event.target.classList.add('active');
    }

    function openReviewModal(employeeId, employeeName, employeeIdStr, role) {
        document.getElementById('employeeId').value = employeeId;
        document.getElementById('selectedMonth').value = document.getElementById('monthSelector').value;
        document.getElementById('employeeName').textContent = employeeName;
        document.getElementById('employeeIdDisplay').textContent = 'ID: ' + employeeIdStr + ' (' + role.toUpperCase() + ')';
        
        let employeeDepartment = null;
        
        <% employeesToReview.forEach(person => { %>
            if ('<%= person._id %>' === employeeId) {
                employeeDepartment = '<%= person.department ? person.department._id : null %>';
            }
        <% }) %>
        
        <% departmentHODsToReview.forEach(person => { %>
            if ('<%= person._id %>' === employeeId) {
                employeeDepartment = '<%= person.department ? person.department._id : null %>';
            }
        <% }) %>
        
        <% otherHODsToReview.forEach(person => { %>
            if ('<%= person._id %>' === employeeId) {
                employeeDepartment = '<%= person.department ? person.department._id : null %>';
            }
        <% }) %>
        
        const questionGroups = document.querySelectorAll('.question-group');
        let visibleQuestions = 0;
        
        questionGroups.forEach(group => {
            const questionDept = group.getAttribute('data-department');
            
            if (questionDept === 'global' || questionDept === employeeDepartment) {
                group.style.display = 'block';
                visibleQuestions++;
                const radioInputs = group.querySelectorAll('input[type="radio"]');
                radioInputs.forEach(input => input.required = true);
            } else {
                group.style.display = 'none';
                const radioInputs = group.querySelectorAll('input[type="radio"]');
                radioInputs.forEach(input => {
                    input.required = false;
                    input.checked = false;
                });
            }
        });

        const previousReview = previousReviewsMap[employeeId];
        const previousReviewSection = document.getElementById('previousReviewSection');
        const previousReviewContent = document.getElementById('previousReviewContent');
        const previousScoreSection = document.getElementById('previousScoreSection');
        const previousScoreDisplay = document.getElementById('previousScore');
        
        if (previousReview) {
            previousScoreSection.style.display = 'block';
            previousScoreDisplay.textContent = (previousReview.overallScore || previousReview.score || 'N/A') + '/6';
            
            previousReviewSection.style.display = 'block';
            
            let reviewHTML = `<p><strong>Month:</strong> ${previousReview.month}</p>`;
            reviewHTML += `<p><strong>Score:</strong> ${previousReview.overallScore || previousReview.score || 'N/A'}/6</p>`;
            
            if (previousReview.answers && previousReview.answers.length > 0) {
                reviewHTML += '<p><strong>Question Ratings:</strong></p><ul style="margin-top: 0.5rem; padding-left: 1.5rem;">';
                previousReview.answers.forEach(answer => {
                    const questionText = answer.question ? answer.question.text : 'Question not found';
                    reviewHTML += `<li>${questionText}: ${answer.rating}/6</li>`;
                });
                reviewHTML += '</ul>';
            }
            
            reviewHTML += `<p><strong>Comments:</strong></p><p style="margin-top: 0.5rem; padding: 0.5rem; background-color: white; border-radius: 3px; font-style: italic;">"${previousReview.comments}"</p>`;
            reviewHTML += `<p style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">Reviewed on: ${new Date(previousReview.reviewDate).toLocaleDateString()}</p>`;
            
            previousReviewContent.innerHTML = reviewHTML;
        } else {
            previousReviewSection.style.display = 'none';
            previousScoreSection.style.display = 'none';
        }
        
        const selfAssessmentSection = document.getElementById('selfAssessmentSection');
        const selfAssessmentContent = document.getElementById('selfAssessmentContent');
        const selfAssessment = selfAssessmentsMap[employeeId];

        if (selfAssessment) {
            selfAssessmentSection.style.display = 'block';
            
            let assessmentHTML = '<div style="background-color: #f9f9f9; padding: 0.75rem; border-radius: 4px;">';
            
            if (selfAssessment.answers && selfAssessment.answers.length > 0) {
                selfAssessment.answers.forEach(answer => {
                    const questionText = answer.question ? answer.question.text : 'Question not found';
                    assessmentHTML += `<div style="margin-bottom: 0.75rem;">
                        <p style="margin: 0; font-weight: 600; font-size: 0.9rem;">${questionText}</p>
                        <p style="margin: 0.25rem 0; color: #555; font-style: italic;">Answer: ${answer.answer}</p>
                    </div>`;
                });
            }
            
            assessmentHTML += `<p style="font-size: 0.85rem; color: #888; margin: 0.5rem 0 0 0;">Submitted on: ${new Date(selfAssessment.submittedDate).toLocaleDateString()}</p>`;
            assessmentHTML += '</div>';
            
            selfAssessmentContent.innerHTML = assessmentHTML;
        } else {
            selfAssessmentSection.style.display = 'none';
        }
        
        document.getElementById('reviewModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closeReviewModal() {
        document.getElementById('reviewModal').style.display = 'none';
        document.getElementById('reviewForm').reset();
        document.body.style.overflow = 'auto';
    }

    document.getElementById('reviewForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const employee = formData.get('employee');
        const month = formData.get('month');
        const comments = formData.get('comments');
        
        const answers = [];
        <% if (questions && questions.length > 0) { %>
            <% questions.forEach(question => { %>
                const rating_<%= question._id.toString().replace(/[^a-zA-Z0-9]/g, '_') %> = formData.get('question_<%= question._id %>');
                if (rating_<%= question._id.toString().replace(/[^a-zA-Z0-9]/g, '_') %>) {
                    answers.push({
                        question: '<%= question._id %>',
                        rating: parseInt(rating_<%= question._id.toString().replace(/[^a-zA-Z0-9]/g, '_') %>)
                    });
                }
            <% }) %>
        <% } %>
        
        if (!comments || comments.trim().length < 10) {
            alert('Please provide detailed comments (at least 10 characters)');
            return;
        }
        
        try {
            const response = await fetch('/hod/reviews', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    employee,
                    month,
                    answers: answers.length > 0 ? answers : null,
                    comments
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('Review submitted successfully!');
                location.reload();
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            console.error('Error submitting review:', error);
            alert('Error submitting review. Please try again.');
        }
    });

    window.onclick = function(event) {
        const modal = document.getElementById('reviewModal');
        if (event.target === modal) {
            closeReviewModal();
        }
    }

    function initializeMonthSelector() {
        const monthSelector = document.getElementById('monthSelector');
        if (monthSelector) {
            monthSelector.value = "<%= selectedMonth %>";
        }
    }

    document.addEventListener('DOMContentLoaded', initializeMonthSelector);
    </script>
</body>
</html>
